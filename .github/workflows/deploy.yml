name: CD - Deploy to EC2
on:
 push:
   branches: [ main, master ]
jobs:
 deploy:
   runs-on: ubuntu-latest
   
   steps:
   - name: Checkout code
     uses: actions/checkout@v4
     
   - name: Set up JDK 17
     uses: actions/setup-java@v4
     with:
       java-version: '17'
       distribution: 'temurin'
       
   # âœ… ë¹Œë“œ ì „ì— application.yml ìƒì„±
   - name: Create application.yml
     run: |
       mkdir -p src/main/resources
       echo '${{ secrets.APPLICATION_YML }}' > src/main/resources/application.yml
       
   - name: Cache Gradle packages
     uses: actions/cache@v3
     with:
       path: |
         ~/.gradle/caches
         ~/.gradle/wrapper
       key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
       restore-keys: |
         ${{ runner.os }}-gradle-
         
   - name: Grant execute permission for gradlew
     run: chmod +x gradlew
     
   - name: Build with Gradle
     run: ./gradlew build
     
   - name: Stop existing application
     uses: appleboy/ssh-action@v0.1.7
     with:
       host: ${{ secrets.EC2_HOST }}
       username: ${{ secrets.EC2_USER }}
       key: ${{ secrets.EC2_PEM_KEY }}
       port: 22
       script: |
         # ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ (ì •í™•í•œ íŒŒì¼ëª…ìœ¼ë¡œ)
         sudo pkill -f "color_walk-0.0.1-SNAPSHOT.jar" || true
         
         # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
         mkdir -p ~/app/backup
         
         # ê¸°ì¡´ JAR íŒŒì¼ ë°±ì—… (ì •í™•í•œ íŒŒì¼ëª…ìœ¼ë¡œ)
         if [ -f ~/app/color_walk-0.0.1-SNAPSHOT.jar ]; then
           mv ~/app/color_walk-0.0.1-SNAPSHOT.jar ~/app/backup/color_walk-$(date +%Y%m%d-%H%M%S).jar
         fi
         
   - name: Copy JAR to EC2
     uses: appleboy/scp-action@v0.1.4
     with:
       host: ${{ secrets.EC2_HOST }}
       username: ${{ secrets.EC2_USER }}
       key: ${{ secrets.EC2_PEM_KEY }}
       port: 22
       source: "build/libs/color_walk-0.0.1-SNAPSHOT.jar"
       target: "~/app/"
       strip_components: 2
       
   - name: Start Application
     uses: appleboy/ssh-action@v0.1.7
     with:
       host: ${{ secrets.EC2_HOST }}
       username: ${{ secrets.EC2_USER }}
       key: ${{ secrets.EC2_PEM_KEY }}
       port: 22
       script: |
         cd ~/app
         
         # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ (ì •í™•í•œ íŒŒì¼ëª…ìœ¼ë¡œ)
         nohup java -jar color_walk-0.0.1-SNAPSHOT.jar > app.log 2>&1 &
         
         # ìƒíƒœ í™•ì¸ (ì •í™•í•œ íŒŒì¼ëª…ìœ¼ë¡œ)
         sleep 10
         if pgrep -f "color_walk-0.0.1-SNAPSHOT.jar" > /dev/null; then
           echo "âœ… Application started successfully"
           echo "Process ID: $(pgrep -f 'color_walk-0.0.1-SNAPSHOT.jar')"
         else
           echo "âŒ Failed to start application"
           echo "Last 20 lines of log:"
           tail -20 app.log
           exit 1
         fi
         
   - name: Deployment notification
     if: always()
     run: |
       if [ "${{ job.status }}" == "success" ]; then
         echo "ğŸš€ ë°°í¬ ì„±ê³µ! ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
       else
         echo "ğŸ’¥ ë°°í¬ ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
       fi
